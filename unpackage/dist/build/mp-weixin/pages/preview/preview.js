"use strict";const e=require("../../common/vendor.js"),a=require("../../api/apis.js"),o=require("../../utils/system.js");if(require("../../utils/request.js"),!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-dateformat")+e.resolveComponent("uni-rate")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-dateformat/components/uni-dateformat/uni-dateformat.js")+(()=>"../../uni_modules/uni-rate/components/uni-rate/uni-rate.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const t={__name:"preview",setup(t){const l=e.ref(!0),i=e.ref(null),n=e.ref(null),s=e.ref(0),u=e.ref([]),r=e.ref(0),c=e.ref(""),p=e.ref([]),d=e.ref(!1),v=e.index.getStorageSync("storeClassList")||[];u.value=null==v?void 0:v.map((e=>({...e,picurl:e.smallPicurl.replace("_small.webp",".jpg")})));const m=e.computed((()=>u.value[r.value]));e.onLoad((async e=>{const{id:o,type:t}=e;if(c.value=o,t&&"share"==t){const e=await a.apiDetailWall({id:o});u.value=e.data.map((e=>({...e,picurl:e.smallPicurl.replace("_small.webp",".jpg")})))}r.value=u.value.findIndex((e=>e._id===o)),j()}));const f=e=>{const{detail:{current:a}}=e;r.value=a,j()},h=()=>{i.value.open()},g=()=>{i.value.close()},w=()=>{m.value.userScore&&(d.value=!0,s.value=m.value.userScore),n.value.open()},x=()=>{s.value=0,n.value.close(),d.value=!1},y=async()=>{e.index.showLoading({title:"加载中..."});let{classid:o,_id:t}=m.value,l=await a.apiGetSetupScore({classid:o,wallId:t,userScore:s.value});e.index.hideLoading(),0===l.errCode&&(e.index.showToast({title:"评分成功",icon:"none"}),u.value[r.value].userScore=s.value,e.index.setStorageSync("storgClassList",u.value),x())},_=()=>{l.value=!l.value},b=()=>{e.index.navigateBack({success:()=>{},fail:()=>{e.index.reLaunch({url:"/pages/index/index "})}})},S=async()=>{try{e.index.showLoading({title:"下载中...",mask:!0});let{classid:o,_id:t}=m.value;const l=await a.apiWriteDownload({classid:o,wallId:t});if(0!=l.errCode)throw l;e.index.getImageInfo({src:m.value.picurl,success:a=>{e.index.saveImageToPhotosAlbum({filePath:a.path,success:a=>{e.index.showToast({title:"保存成功，请到相册查看",icon:"none"})},fail:a=>{"saveImageToPhotosAlbum:fail cancel"!=a.errMsg?e.index.showModal({title:"授权提示",content:"需要授权保存相册",success:a=>{a.confirm&&e.index.openSetting({success:a=>{a.authSetting["scope.writePhotosAlbum"]?e.index.showToast({title:"获取授权成功",icon:"none"}):e.index.showToast({title:"获取权限失败",icon:"none"})}})},fail:()=>{}}):e.index.showToast({title:"保存失败，请重新点击下载",icon:"none"})},complete:()=>{e.index.hideLoading()}})}})}catch(o){console.log(o),e.index.hideLoading()}};e.onShareAppMessage((()=>({title:"呆桃的小屋",path:`/pages/preview/preview?id=${c.value}&type=share`}))),e.onShareTimeline((()=>({title:"呆桃的小屋",query:`id=${c.value}&type=share`})));const j=()=>{p.value.push(r.value<=0?u.length-1:r.value-1,r.value,r>=u.length-1?0:r+1),p.value=[...new Set(p.value)]};return(a,t)=>e.e({a:e.f(u.value,((a,o,t)=>e.e({a:p.value.includes(o)},p.value.includes(o)?{b:e.o(_,a._id),c:a.picurl}:{},{d:a._id}))),b:r.value,c:e.o(f),d:l.value},l.value?{e:e.p({type:"back",color:"#fff",size:"20"}),f:e.o(b),g:e.unref(o.getStatusBarHeight)()+"px",h:e.t(r.value+1),i:e.t(u.value.length),j:e.p({date:new Date,format:"hh:mm"}),k:e.p({date:new Date,format:"MM月dd日"}),l:e.p({type:"info",size:"28"}),m:e.o(h),n:e.p({type:"star",size:"28"}),o:e.t(e.unref(m).score),p:e.o(w),q:e.p({type:"download",size:"23"}),r:e.o(S)}:{},{s:e.p({type:"closeempty",size:"18",color:"#999"}),t:e.o(g),v:e.t(e.unref(m)._id),w:e.t(e.unref(m).nickname),x:e.p({readonly:!0,touchable:!0,value:e.unref(m).score,size:"16"}),y:e.t(e.unref(m).score),z:e.t(e.unref(m).description),A:e.f(e.unref(m).tabs,((a,o,t)=>({a:e.t(a),b:a}))),B:e.sr(i,"325be84f-6",{k:"infoPopup"}),C:e.p({type:"bottom"}),D:e.t(d.value?"已经评分过～":"壁纸评分"),E:e.p({type:"closeempty",size:"18",color:"#999"}),F:e.o(x),G:e.o((e=>s.value=e)),H:e.p({"disabled-color":"#FFCA3E",disabled:d.value,allowHalf:!0,modelValue:s.value}),I:e.t(s.value),J:e.o(y),K:!s.value||d.value,L:e.sr(n,"325be84f-9",{k:"scorePopup"}),M:e.p({"is-mask-click":!1})})}},l=e._export_sfc(t,[["__scopeId","data-v-325be84f"]]);t.__runtimeHooks=6,wx.createPage(l);
